# Unified Sampling Framework (USF)

This is the repository of the paper "A Unified Sampling Framework for Solver Searching of Diffusion Probabilistic Models". We provide some example solver schedules to reproduce our results in the paper.

## Environment
```bash
pip install torch torchvision pytorch-fid tqdm protobuf
```

Details of our environment are provided in **usf_env.yml**
## Dataset, Checkpoint and FID Stats
- Please check the config files in `configs/`.
- Download the pretrained models

  ```shell
  mkdir -p checkpoints/imagenet256
  wget -O checkpoints/imagenet256/256x256_diffusion.pt https://openaipublic.blob.core.windows.net/diffusion/jul-2021/256x256_diffusion.pt
  wget -O checkpoints/imagenet256/256x256_classifier.pt https://openaipublic.blob.core.windows.net/diffusion/jul-2021/256x256_classifier.pt
  ```

- Download the folder `imagenet256_guided` from https://drive.google.com/drive/folders/1sWq-htX9c3Xdajmo1BG-QvkbaeVtJqaq and put it under the folder `dpm_solver_v3/`.
- Download fid statistics from https://openaipublic.blob.core.windows.net/diffusion/jul-2021/ref_batches/imagenet/256/VIRTUAL_imagenet256_labeled.npz and put it under `fid_stats/`

## Command
We provide a command for sampling and FID evaluation here.
```bash
python main.py --config configs/imagenet256_guided.yml --sample_type unisampler --gpu 0 --exp exps/nfe3 --sample --fid --load_decision solver_schedules/imagenet256_nfe3.pth --statistics_dir dpm_solver_v3/imagenet256_guided/500_1024 --number_of_samples 10000 --fid
```

We also implemented DPM-Solver++, UniPC, DPM-Solver-v3 in this code base. The command are as follows:
```bash
python main.py --config configs/imagenet256_guided.yml --gpu 0 --exp exps/dpmsolver++ --sample --fid  --statistics_dir dpm_solver_v3/imagenet256_guided/500_1024 --number_of_samples 10000 --sample_type dpmsolver++ --timesteps 5

python main.py --config configs/imagenet256_guided.yml --gpu 0 --exp exps/unipc --sample --fid  --statistics_dir dpm_solver_v3/dpm_solver_v3/imagenet256_guided/500_1024 --number_of_samples 10000 --sample_type unipc --timesteps 5

python main.py --config configs/imagenet256_guided.yml --gpu 0 --exp exps/dpmsolver_v3 --sample --fid  --statistics_dir dpm_solver_v3/imagenet256_guided/500_1024 --number_of_samples 10000 --sample_type dpmsolver_v3 --timesteps 5
```
Details about how to use these implement can be found in `main.py`'s args. **Notice**: The FID of baseline methods we report below are searched best settings (under their framework), so directly use the default settings might get worse FID performance. 

## Searched solver-schedules
They are stored in `solver_schedules`. If you want to search new solver schedules, please check the `search.py`.

## FID results evaluated on 50k samples
| **Method**       | **3**    | **4**    | **5**    | **6**    | **7**    | **8**    | **9**    | **10**   |
|-------------------|----------|----------|----------|----------|----------|----------|----------|----------|
| DPM-Solver++     | 53.14    | 26.3     | 16.97    | 12.92    | 11.04    | 9.88     | 9.14     | 8.75     |
| UniPC            | 53.30    | 25.00    | 15.65    | 11.86    | 10.20    | 9.30     | 8.75     | 8.43     |
| DPM-Solver-v3    | 57.52    | 26.87    | 15.21    | 11.30    | 9.74     | 8.93     | 8.54     | 8.22     |
| Ours             | **32.71**| **18.64**| **13.42**| **10.80**| **9.57** | **8.85** | **8.34** | **8.18** |


## Samples generated by searched solver-schedules
<div style="display: flex; justify-content: space-around;">

  <div style="text-align: center;">
    <img src="solver_schedules/images/nfe4_usf.png" alt="USF" width="300">
    <p>Samples generated by USF NFE=4</p>
  </div>

  <div style="text-align: center;">
    <img src="solver_schedules/images/nfe4_dpm_solver_v3.png" alt="DPM-Solver-v3" width="300">
    <p>Samples generated by DPM-Solver-v3 NFE=4</p>
  </div>

</div>