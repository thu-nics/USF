# Unified Sampling Framework (USF)

This is the repository of the paper "A Unified Sampling Framework for Solver Searching of Diffusion Probabilistic Models". We provide some example solver schedules to reproduce our results in the paper.

## Environment
```bash
pip install torch torchvision pytorch-fid tqdm protobuf
```

Details of our environment are provided in **usf_env.yml**
## Dataset, Checkpoint and FID Stats
Please check the config files in `configs/`.

Please put the download model to `checkpoints/`. For model loading, please check this code for details: `functions/ckpt_util.py`. If you want to use other FID Stats to further verify our results, please put it in the `fid_stats/cifar10` and run our code in `evaluate/fid_score.py`. You can change the fid_stats' location in `configs/cifar10_continuous.yml`. `main.py` support compute fid automatically if set '--fid'.

| Config File            | Checkpoint                                                   | Other FID Stats                                              |
| ---------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| cifar10_continouous.yml            | Download [ScoreSDE checkpoint on CIFAR-10](https://drive.google.com/drive/folders/1ZMLBiu9j7-rpdTQu8M2LlHAEQq4xRYrj) in `checkpoints/`. | [Download](https://drive.google.com/drive/folders/1_OpTXVPLffZM8BG-V3Ahsxk99aqxW7C3?usp=sharing) `fid_stats_cifar10_train_pytorch.npz` |

## DPM-Solver-v3's EMS **(Requied)**
Download the folder `edm-cifar10-32x32-uncond-vp` from https://drive.google.com/drive/folders/1sWq-htX9c3Xdajmo1BG-QvkbaeVtJqaq and put it under the folder `dpm_solver_v3/`.

## Command
We provide a command for sampling and FID evaluation here.
```bash
python main.py --config cifar10_continuous.yml --sample_type unisampler --gpu 4 --exp exps/nfe3 --sample --fid --load_decision solver_schedules/cifar10_sde_nfe3.pth --statistics_dir dpm_solver_v3/cifar10_ddpmpp_deep_continuous/0.0001_1200_4096 --number_of_samples 50000
```

We also implemented DPM-Solver++, UniPC, DPM-Solver-v3 in this code base. The command are as follows:
```bash
python main.py --config cifar10_continuous.yml --gpu 4 --exp exps/dpmsolver++ --sample --fid  --statistics_dir dpm_solver_v3/cifar10_ddpmpp_deep_continuous/0.0001_1200_4096 --number_of_samples 50000 --sample_type dpmsolver++ --timesteps 5

python main.py --config cifar10_continuous.yml --gpu 4 --exp exps/unipc --sample --fid  --statistics_dir dpm_solver_v3/cifar10_ddpmpp_deep_continuous/0.0001_1200_4096 --number_of_samples 50000 --sample_type unipc --timesteps 5

python main.py --config cifar10_continuous.yml --gpu 4 --exp exps/dpmsolver_v3 --sample --fid  --statistics_dir dpm_solver_v3/cifar10_ddpmpp_deep_continuous/0.0001_1200_4096 --number_of_samples 50000 --sample_type dpmsolver_v3 --timesteps 5
```
Details about how to use these implement can be found in `main.py`'s args. **Notice**: The FID of baseline methods we report below are searched best settings (under their framework), so directly use the default settings might get worse FID performance. 

## Searched solver-schedules
They are stored in `solver_schedules`. If you want to search new solver schedules, please check the `search.py`.

## FID results evaluated on 50k samples
| **Method**        | **NFE: 3** | **NFE: 4** | **NFE: 5** | **NFE: 6** | **NFE: 7** | **NFE: 8** | **NFE: 9** | **NFE: 10** |
|--------------------|------------|------------|------------|------------|------------|------------|------------|-------------|
| DPM-Solver++       | 91.24      | 61.37      | 28.39      | 13.41      | 7.44       | 5.33       | 4.37       | 3.99        |
| UniPC              | 93.52      | 60.43      | 23.62      | 10.41      | 6.49       | 5.16       | 4.30       | 3.89        |
| DPM-Solver-v3      | 139.8      | 34.69      | 12.74      | 7.46       | 5.18       | 3.94       | 3.65       | 3.39        |
| **Ours**           | **13.30**  | **6.81**   | **5.40**   | **4.05**   | **3.60**   | **3.00**   | **2.83**   | **2.70**    |

## Samples generated by searched solver-schedules
<div style="display: flex; justify-content: space-around;">

  <div style="text-align: center;">
    <img src="solver_schedules/images/nfe5_usf.png" alt="USF" width="300">
    <p>Samples generated by USF NFE=5</p>
  </div>

  <div style="text-align: center;">
    <img src="solver_schedules/images/nfe5_dpm_solver_v3.png" alt="DPM-Solver-v3" width="300">
    <p>Samples generated by DPM-Solver-v3 NFE=5</p>
  </div>

</div>